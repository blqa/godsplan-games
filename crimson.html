<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crimson Puzzle - God's Plan</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel (para interpretar JSX en el navegador) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Estilos personalizados -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;700;900&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #050000;
        }
        
        .font-mono {
            font-family: 'JetBrains Mono', monospace;
        }

        .inner-shadow {
            box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.6);
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-4px) rotate(-3deg); }
            75% { transform: translateX(4px) rotate(3deg); }
        }

        /* Utilidad para el efecto hover del texto en navbar */
        .hover-scramble:hover {
            color: #ef4444; /* red-500 */
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef } = React;

        // --- Lógica del Puzzle ---

        const getSolvedState = (size) => {
            const state = Array.from({ length: size * size }, (_, i) => i + 1);
            state[state.length - 1] = 0; 
            return state;
        };

        const isSolved = (board) => {
            if (board.length === 0) return false;
            const size = Math.sqrt(board.length);
            const solved = getSolvedState(size);
            return board.every((val, index) => val === solved[index]);
        };

        const shuffleBoard = (size) => {
            let board = getSolvedState(size);
            let emptyIndex = board.length - 1;
            let previousIndex = -1;
            const shuffleMoves = size * size * 15; 

            for (let i = 0; i < shuffleMoves; i++) {
                const moves = [];
                const row = Math.floor(emptyIndex / size);
                const col = emptyIndex % size;

                if (row > 0) moves.push(emptyIndex - size); 
                if (row < size - 1) moves.push(emptyIndex + size); 
                if (col > 0) moves.push(emptyIndex - 1); 
                if (col < size - 1) moves.push(emptyIndex + 1); 

                const validMoves = moves.filter(idx => idx !== previousIndex);
                
                if (validMoves.length > 0) {
                    const randomMove = validMoves[Math.floor(Math.random() * validMoves.length)];
                    [board[emptyIndex], board[randomMove]] = [board[randomMove], board[emptyIndex]];
                    previousIndex = emptyIndex;
                    emptyIndex = randomMove;
                }
            }
            return board;
        };

        function RedGlassUltimate() {
            const [size, setSize] = useState(4);
            const [board, setBoard] = useState([]);
            const [moves, setMoves] = useState(0);
            const [bestScore, setBestScore] = useState(0);
            const [time, setTime] = useState(0);
            const [gameState, setGameState] = useState('start'); 
            const [emptyIndex, setEmptyIndex] = useState(-1);
            const [history, setHistory] = useState([]); 
            const [isBlindMode, setIsBlindMode] = useState(false); 
            const [shakingTile, setShakingTile] = useState(null);
            
            // Estado para la Navbar
            const [currentDate, setCurrentDate] = useState(new Date());

            const touchStart = useRef({ x: 0, y: 0 });

            useEffect(() => {
                const savedBest = localStorage.getItem(`crimson_best_${size}`);
                setBestScore(savedBest ? parseInt(savedBest) : 0);
            }, [size]);

            useEffect(() => {
                startNewGame(size);
            }, [size]);

            useEffect(() => {
                if (board.length > 0) {
                    setEmptyIndex(board.indexOf(0));
                }
            }, [board]);

            useEffect(() => {
                let interval;
                if (gameState === 'playing') {
                    interval = setInterval(() => {
                        setTime(t => t + 1);
                    }, 1000);
                }
                return () => clearInterval(interval);
            }, [gameState]);

            // Reloj Navbar
            useEffect(() => {
                const sysTimer = setInterval(() => {
                    setCurrentDate(new Date());
                }, 1000);
                return () => clearInterval(sysTimer);
            }, []);

            useEffect(() => {
                const handleKeyDown = (e) => {
                    if (gameState !== 'playing') return;
                    
                    const row = Math.floor(emptyIndex / size);
                    const col = emptyIndex % size;
                    let targetIndex = -1;

                    switch (e.key) {
                        case 'ArrowUp': 
                            if (row < size - 1) targetIndex = emptyIndex + size; 
                            break;
                        case 'ArrowDown':
                            if (row > 0) targetIndex = emptyIndex - size;
                            break;
                        case 'ArrowLeft':
                            if (col < size - 1) targetIndex = emptyIndex + 1;
                            break;
                        case 'ArrowRight':
                            if (col > 0) targetIndex = emptyIndex - 1;
                            break;
                        default: return;
                    }

                    if (targetIndex !== -1) {
                        e.preventDefault();
                        moveTile(targetIndex);
                    }
                };

                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, [board, emptyIndex, gameState, size]);

            const startNewGame = (currentSize = size) => {
                const newBoard = shuffleBoard(currentSize);
                setBoard(newBoard);
                setMoves(0);
                setTime(0);
                setHistory([]);
                setGameState('playing');
                setIsBlindMode(false);
            };

            const undoMove = () => {
                if (history.length === 0 || gameState === 'won') return;
                
                const previousBoard = history[history.length - 1];
                setBoard(previousBoard);
                setHistory(prev => prev.slice(0, -1));
                setMoves(m => Math.max(0, m - 1));
            };

            const moveTile = (index) => {
                if (gameState === 'won') return;

                const row = Math.floor(index / size);
                const col = index % size;
                const emptyRow = Math.floor(emptyIndex / size);
                const emptyCol = emptyIndex % size;

                const isAdjacent = (Math.abs(row - emptyRow) + Math.abs(col - emptyCol)) === 1;

                if (isAdjacent) {
                    setHistory(prev => [...prev, [...board]]);

                    const newBoard = [...board];
                    [newBoard[index], newBoard[emptyIndex]] = [newBoard[emptyIndex], newBoard[index]];
                    
                    setBoard(newBoard);
                    const newMoves = moves + 1;
                    setMoves(newMoves);

                    if (isSolved(newBoard)) {
                        setGameState('won');
                        if (bestScore === 0 || newMoves < bestScore) {
                            setBestScore(newMoves);
                            localStorage.setItem(`crimson_best_${size}`, newMoves);
                        }
                    }
                } else {
                    setShakingTile(index);
                    setTimeout(() => setShakingTile(null), 400);
                }
            };

            const handleTouchStart = (e) => {
                touchStart.current = { x: e.touches[0].clientX, y: e.touches[0].clientY };
            };

            const handleTouchEnd = (e) => {
                if (gameState !== 'playing') return;

                const touchEnd = { x: e.changedTouches[0].clientX, y: e.changedTouches[0].clientY };
                const diffX = touchStart.current.x - touchEnd.x;
                const diffY = touchStart.current.y - touchEnd.y;

                const row = Math.floor(emptyIndex / size);
                const col = emptyIndex % size;
                let targetIndex = -1;

                if (Math.abs(diffX) < 30 && Math.abs(diffY) < 30) return;

                if (Math.abs(diffX) > Math.abs(diffY)) {
                    if (diffX > 0) { 
                        if (col < size - 1) targetIndex = emptyIndex + 1;
                    } else { 
                        if (col > 0) targetIndex = emptyIndex - 1;
                    }
                } else {
                    if (diffY > 0) { 
                        if (row < size - 1) targetIndex = emptyIndex + size;
                    } else { 
                        if (row > 0) targetIndex = emptyIndex - size;
                    }
                }

                if (targetIndex !== -1) moveTile(targetIndex);
            };

            const formatTime = (seconds) => {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
            };

            // Grid size ajustado a ser más pequeño (Compact Mode)
            const getGridClass = () => {
                if (size === 3) return 'grid-cols-3 w-[280px] h-[280px] sm:w-[320px] sm:h-[320px]';
                if (size === 4) return 'grid-cols-4 w-[280px] h-[280px] sm:w-[350px] sm:h-[350px]';
                if (size === 5) return 'grid-cols-5 w-[280px] h-[280px] sm:w-[380px] sm:h-[380px]';
                return 'grid-cols-4';
            };

            return (
                <div 
                    className="min-h-screen bg-[#050000] text-white font-sans flex flex-col items-center px-4 select-none relative overflow-hidden touch-none pt-20"
                    onTouchStart={handleTouchStart}
                    onTouchEnd={handleTouchEnd}
                >
                    
                    {/* --- NAVBAR --- */}
                    <nav className="fixed top-0 left-0 right-0 z-50 px-6 py-3 backdrop-blur-md border-b border-white/5 bg-black/40">
                        <div className="max-w-7xl mx-auto flex justify-between items-center">
                            
                            {/* Logo */}
                            <a href="https://games.godsplan.site" className="flex items-center gap-3 cursor-pointer group no-underline">
                                <div className="relative w-8 h-8 flex items-center justify-center overflow-hidden rounded-full bg-zinc-900 border border-zinc-800 group-hover:border-red-500/50 transition-colors">
                                    <i className="ph-duotone ph-planet text-red-500 text-xl relative z-10 group-hover:rotate-180 transition-transform duration-700 ease-in-out"></i>
                                </div>
                                <div className="flex flex-col">
                                    <span className="font-bold tracking-tight text-white leading-none text-sm group-hover:text-red-500 transition-colors">GOD'S PLAN</span>
                                    <span className="text-[8px] text-zinc-500 font-mono tracking-widest uppercase">Nexus Hub v4.1</span>
                                </div>
                            </a>

                            {/* Right Controls */}
                            <div className="flex items-center gap-4">
                                {/* Clock */}
                                <div className="hidden md:flex flex-col items-end text-right border-r border-white/10 pr-4">
                                    <span id="sys-time" className="font-mono text-[10px] text-zinc-300 font-bold">
                                        {currentDate.toLocaleTimeString('en-US', { hour12: false })}
                                    </span>
                                    <span id="sys-date" className="text-[9px] text-zinc-600 uppercase tracking-widest">
                                        {currentDate.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' }).toUpperCase()}
                                    </span>
                                </div>

                                {/* Status */}
                                <div className="flex items-center gap-2 px-2 py-0.5 rounded-full bg-emerald-950/30 border border-emerald-500/20">
                                    <span className="relative flex h-1.5 w-1.5">
                                        <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
                                        <span className="relative inline-flex rounded-full h-1.5 w-1.5 bg-emerald-500"></span>
                                    </span>
                                    <span className="hidden sm:block text-[9px] font-bold text-emerald-500 tracking-wider">ONLINE</span>
                                </div>

                                {/* Contact */}
                                <a href="https://games.godsplan.site" className="w-8 h-8 flex items-center justify-center rounded-lg bg-zinc-900 hover:bg-zinc-800 text-zinc-400 hover:text-white transition-all border border-white/10 group">
                                    <i className="ph-bold ph-paper-plane-right group-hover:-translate-y-0.5 group-hover:translate-x-0.5 transition-transform text-base"></i>
                                </a>
                            </div>
                        </div>
                    </nav>

                    {/* Background Ambience Animations */}
                    <div className="absolute top-0 left-0 w-full h-full overflow-hidden pointer-events-none z-0">
                        <div className="absolute top-[-20%] left-[-10%] w-[60%] h-[60%] bg-red-900/20 rounded-full blur-[120px] animate-pulse"></div>
                        <div className="absolute bottom-[-10%] right-[-20%] w-[60%] h-[60%] bg-red-800/10 rounded-full blur-[120px] animate-pulse" style={{ animationDelay: '2s' }}></div>
                    </div>

                    <div className="z-10 w-full max-w-md flex flex-col items-center relative mt-2">
                        
                        {/* Header Compacto */}
                        <div className="w-full flex justify-between items-end mb-4">
                            <div>
                                <h1 className="text-3xl md:text-4xl font-black tracking-tighter italic text-red-500 drop-shadow-[0_0_15px_rgba(220,38,38,0.6)] leading-none">
                                    CRIMSON
                                </h1>
                                <p className="text-white/60 text-xs font-mono tracking-widest mt-1">SLIDE PUZZLE</p>
                            </div>
                            
                            <div className="flex gap-2">
                                <div className="bg-white/10 backdrop-blur-md rounded-lg p-1.5 min-w-[60px] flex flex-col items-center border border-white/5">
                                    <span className="text-[9px] text-red-200 font-bold uppercase tracking-wider">Moves</span>
                                    <span className="text-lg font-bold text-white leading-none">{moves}</span>
                                </div>
                                <div className="bg-white/10 backdrop-blur-md rounded-lg p-1.5 min-w-[60px] flex flex-col items-center border border-white/5">
                                    <span className="text-[9px] text-red-200 font-bold uppercase tracking-wider">Best</span>
                                    <span className="text-lg font-bold text-white leading-none">{bestScore > 0 ? bestScore : '-'}</span>
                                </div>
                            </div>
                        </div>

                        {/* Action Bar Compacta */}
                        <div className="w-full flex justify-between items-center mb-4 bg-white/5 p-1.5 rounded-lg border border-white/5 backdrop-blur-sm">
                            <div className="flex gap-1">
                                {[3, 4, 5].map((s) => (
                                <button 
                                    key={s}
                                    onClick={() => setSize(s)}
                                    className={`h-7 w-8 flex items-center justify-center rounded transition-all duration-300 ${size === s ? 'bg-red-600 text-white shadow-lg shadow-red-900/50' : 'text-gray-500 hover:bg-white/10'}`}
                                >
                                    <span className="font-bold text-[10px]">{s}x{s}</span>
                                </button>
                                ))}
                            </div>

                            <div className="flex gap-2">
                                <button 
                                    onClick={() => setIsBlindMode(!isBlindMode)}
                                    className={`p-1.5 rounded transition-colors ${isBlindMode ? 'text-red-400 bg-red-900/20' : 'text-gray-400 hover:text-white'}`}
                                    title="Modo Ciego"
                                >
                                    {isBlindMode ? <i className="ph ph-eye-slash text-base"></i> : <i className="ph ph-eye text-base"></i>} 
                                </button>
                                <button 
                                    onClick={() => startNewGame(size)}
                                    className="flex items-center gap-1.5 bg-red-600 hover:bg-red-500 text-white px-3 py-1 rounded font-bold text-xs shadow-[0_0_15px_rgba(220,38,38,0.4)] transition-all active:scale-95"
                                >
                                    <i className="ph-bold ph-arrows-clockwise"></i> NEW GAME
                                </button>
                            </div>
                        </div>

                        {/* Board Container */}
                        <div className="relative p-2 bg-gray-900/80 backdrop-blur-xl rounded-xl border border-white/10 shadow-2xl ring-1 ring-white/5">
                            
                            {/* Victory Overlay */}
                            {gameState === 'won' && (
                            <div className="absolute inset-0 z-20 bg-black/80 backdrop-blur-sm rounded-xl flex flex-col items-center justify-center animate-in fade-in zoom-in duration-300">
                                <i className="ph-fill ph-trophy text-yellow-500 text-5xl mb-3 drop-shadow-[0_0_25px_rgba(234,179,8,0.6)] animate-bounce"></i>
                                <h2 className="text-3xl font-black text-white mb-2 italic">YOU WIN!</h2>
                                <div className="flex gap-6 mb-5 text-xs font-mono text-gray-300">
                                    <div className="flex flex-col items-center">
                                        <span className="text-[10px] uppercase text-gray-500">Time</span>
                                        <span className="text-lg text-white">{formatTime(time)}</span>
                                    </div>
                                    <div className="flex flex-col items-center">
                                        <span className="text-[10px] uppercase text-gray-500">Moves</span>
                                        <span className="text-lg text-white">{moves}</span>
                                    </div>
                                </div>
                                <button 
                                onClick={() => startNewGame(size)}
                                className="px-6 py-2 bg-white text-black rounded font-black uppercase tracking-widest text-sm hover:bg-gray-200 transition-transform active:scale-95 shadow-[0_0_20px_rgba(255,255,255,0.3)]"
                                >
                                    Try Again
                                </button>
                            </div>
                            )}

                            <div className={`grid gap-2 transition-all duration-300 ${getGridClass()}`}>
                            {board.map((num, index) => {
                                if (num === 0) return <div key="empty" className="w-full h-full rounded-md bg-black/40 inner-shadow"></div>;
                                
                                const isCorrectPos = num === index + 1;
                                const isShaking = shakingTile === index;

                                return (
                                <div
                                    key={num}
                                    onClick={() => moveTile(index)}
                                    className={`
                                    w-full h-full rounded-md text-xl sm:text-3xl font-black flex items-center justify-center relative cursor-pointer select-none transition-all duration-150 transform
                                    ${isShaking ? 'animate-[shake_0.4s_ease-in-out]' : ''}
                                    ${isCorrectPos 
                                        ? 'bg-gradient-to-br from-red-500 to-red-700 shadow-[0_0_15px_rgba(220,38,38,0.3)] text-white border border-red-400/30' 
                                        : 'bg-[#3e3939] text-gray-200 shadow-lg border border-white/5 hover:bg-[#4d4646]'}
                                    `}
                                >
                                    {/* Number */}
                                    <span className={`z-10 transition-all duration-300 ${isBlindMode ? 'opacity-0 scale-50' : 'opacity-100'}`}>
                                        {num}
                                    </span>
                                    
                                    {/* Blind Mode Dot */}
                                    {isBlindMode && (
                                        <div className={`absolute w-1.5 h-1.5 rounded-full ${isCorrectPos ? 'bg-white shadow-[0_0_8px_white]' : 'bg-gray-600'}`}></div>
                                    )}
                                </div>
                                );
                            })}
                            </div>
                        </div>
                        
                        {/* Footer Info */}
                        <div className="mt-4 flex justify-between w-full text-[10px] text-gray-500 font-mono px-2">
                            <div className="flex items-center gap-3">
                                <span className="flex items-center gap-1"><i className="ph-bold ph-clock"></i> {formatTime(time)}</span>
                                <button onClick={undoMove} disabled={history.length === 0} className="flex items-center gap-1 hover:text-red-400 disabled:opacity-30 transition-colors">
                                    <i className="ph-bold ph-arrow-counter-clockwise"></i> UNDO
                                </button>
                            </div>
                            <div className="flex items-center gap-2">
                                <span className="hidden sm:flex items-center gap-1"><i className="ph-bold ph-keyboard"></i> Arrows</span>
                                <span className="flex items-center gap-1"><i className="ph-bold ph-hand-swipe"></i> Swipe</span>
                            </div>
                        </div>

                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<RedGlassUltimate />);
    </script>
</body>
</html>
